"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProtocolClient = void 0;
const ee = require("events");
class ProtocolClient extends ee.EventEmitter {
    constructor() {
        super();
        this.pendingRequests = new Map();
        this.rawData = Buffer.alloc(0);
        this.sequence = 1;
        this.contentLength = -1;
    }
    connect(readable, writable) {
        this.outputStream = writable;
        readable.on('data', (data) => {
            this.handleData(data);
        });
    }
    send(command, args) {
        return new Promise((completeDispatch, errorDispatch) => {
            this.doSend(command, args, (result) => {
                if (result.success) {
                    completeDispatch(result);
                }
                else {
                    errorDispatch(new Error(result.message));
                }
            });
        });
    }
    doSend(command, args, clb) {
        const request = {
            type: 'request',
            seq: this.sequence++,
            command: command
        };
        if (args && Object.keys(args).length > 0) {
            request.arguments = args;
        }
        // store callback for this request
        this.pendingRequests.set(request.seq, clb);
        const json = JSON.stringify(request);
        this.outputStream.write(`Content-Length: ${Buffer.byteLength(json, 'utf8')}\r\n\r\n${json}`, 'utf8');
    }
    handleData(data) {
        this.rawData = Buffer.concat([this.rawData, data]);
        while (true) {
            if (this.contentLength >= 0) {
                if (this.rawData.length >= this.contentLength) {
                    const message = this.rawData.toString('utf8', 0, this.contentLength);
                    this.rawData = this.rawData.slice(this.contentLength);
                    this.contentLength = -1;
                    if (message.length > 0) {
                        this.dispatch(message);
                    }
                    continue; // there may be more complete messages to process
                }
            }
            else {
                const idx = this.rawData.indexOf(ProtocolClient.TWO_CRLF);
                if (idx !== -1) {
                    const header = this.rawData.toString('utf8', 0, idx);
                    const lines = header.split('\r\n');
                    for (let i = 0; i < lines.length; i++) {
                        const pair = lines[i].split(/: +/);
                        if (pair[0] === 'Content-Length') {
                            this.contentLength = +pair[1];
                        }
                    }
                    this.rawData = this.rawData.slice(idx + ProtocolClient.TWO_CRLF.length);
                    continue;
                }
            }
            break;
        }
    }
    dispatch(body) {
        const rawData = JSON.parse(body);
        if (typeof rawData.event !== 'undefined') {
            const event = rawData;
            this.emit(event.event, event);
        }
        else {
            const response = rawData;
            const clb = this.pendingRequests.get(response.request_seq);
            if (clb) {
                this.pendingRequests.delete(response.request_seq);
                clb(response);
            }
        }
    }
}
exports.ProtocolClient = ProtocolClient;
ProtocolClient.TWO_CRLF = '\r\n\r\n';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2xDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvdG9jb2xDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Z0dBR2dHOzs7QUFHaEcsNkJBQTZCO0FBRzdCLE1BQWEsY0FBZSxTQUFRLEVBQUUsQ0FBQyxZQUFZO0lBVWxEO1FBQ0MsS0FBSyxFQUFFLENBQUM7UUFMRCxvQkFBZSxHQUFHLElBQUksR0FBRyxFQUErQyxDQUFDO1FBQ3pFLFlBQU8sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBS2pDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVTLE9BQU8sQ0FBQyxRQUF5QixFQUFFLFFBQXlCO1FBRXJFLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1FBRTdCLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBWSxFQUFFLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFvQ00sSUFBSSxDQUFDLE9BQWUsRUFBRSxJQUFVO1FBRXRDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxhQUFhLEVBQUUsRUFBRTtZQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxNQUE4QixFQUFFLEVBQUU7Z0JBQzdELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDbkIsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ3pCO3FCQUFNO29CQUNOLGFBQWEsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztpQkFDekM7WUFDRixDQUFDLENBQUMs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aUJBQ1Q7YUFDRDtZQUNELE1BQU07U0FDTjtJQUNGLENBQUM7SUFFTyxRQUFRLENBQUMsSUFBWTtRQUU1QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWpDLElBQUksT0FBTyxPQUFPLENBQUMsS0FBSyxLQUFLLFdBQVcsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBeUIsT0FBTyxDQUFDO1lBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ04sTUFBTSxRQUFRLEdBQTRCLE9BQU8sQ0FBQztZQUNsRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDM0QsSUFBSSxHQUFHLEVBQUU7Z0JBQ1IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNsRCxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDZDtTQUNEO0lBQ0YsQ0FBQzs7QUEzSUYsd0NBNElDO0FBMUllLHVCQUFRLEdBQUcsVUFBVSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqICBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXG5cbmltcG9ydCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbmltcG9ydCAqIGFzIGVlIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQge0RlYnVnUHJvdG9jb2x9IGZyb20gJ3ZzY29kZS1kZWJ1Z3Byb3RvY29sJztcblxuZXhwb3J0IGNsYXNzIFByb3RvY29sQ2xpZW50IGV4dGVuZHMgZWUuRXZlbnRFbWl0dGVyIHtcblxuXHRwcml2YXRlIHN0YXRpYyBUV09fQ1JMRiA9ICdcXHJcXG5cXHJcXG4nO1xuXG5cdHByaXZhdGUgb3V0cHV0U3RyZWFtOiBzdHJlYW0uV3JpdGFibGU7XG5cdHByaXZhdGUgc2VxdWVuY2U6IG51bWJlcjtcblx0cHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHMgPSBuZXcgTWFwPG51bWJlciwgKGU6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UpID0+IHZvaWQ+KCk7XG5cdHByaXZhdGUgcmF3RGF0YSA9IEJ1ZmZlci5hbGxvYygwKTtcblx0cHJpdmF0ZSBjb250ZW50TGVuZ3RoOiBudW1iZXI7XG5cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLnNlcXVlbmNlID0gMTtcblx0XHR0aGlzLmNvbnRlbnRMZW5ndGggPSAtMTtcblx0fVxuXG5cdHByb3RlY3RlZCBjb25uZWN0KHJlYWRhYmxlOiBzdHJlYW0uUmVhZGFibGUsIHdyaXRhYmxlOiBzdHJlYW0uV3JpdGFibGUpOiB2b2lkIHtcblxuXHRcdHRoaXMub3V0cHV0U3RyZWFtID0gd3JpdGFibGU7XG5cblx0XHRyZWFkYWJsZS5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcblx0XHRcdHRoaXMuaGFuZGxlRGF0YShkYXRhKTtcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdpbml0aWFsaXplJywgYXJnczogRGVidWdQcm90b2NvbC5Jbml0aWFsaXplUmVxdWVzdEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuSW5pdGlhbGl6ZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2NvbmZpZ3VyYXRpb25Eb25lJywgYXJnczogRGVidWdQcm90b2NvbC5Db25maWd1cmF0aW9uRG9uZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29uZmlndXJhdGlvbkRvbmVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdsYXVuY2gnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkxhdW5jaFJlcXVlc3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkxhdW5jaFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2F0dGFjaCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuQXR0YWNoUmVxdWVzdEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQXR0YWNoUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAncmVzdGFydCcsIGFyZ3M6IERlYnVnUHJvdG9jb2wuUmVzdGFydEFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzdGFydFJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2Rpc2Nvbm5lY3QnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkRpc2Nvbm5lY3RBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLkRpc2Nvbm5lY3RSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzZXRCcmVha3BvaW50cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0QnJlYWtwb2ludHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldEJyZWFrcG9pbnRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2V0RnVuY3Rpb25CcmVha3BvaW50cycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU2V0RnVuY3Rpb25CcmVha3BvaW50c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0RnVuY3Rpb25CcmVha3BvaW50c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3NldEV4Y2VwdGlvbkJyZWFrcG9pbnRzJywgYXJnczogRGVidWdQcm90b2NvbC5TZXRFeGNlcHRpb25CcmVha3BvaW50c0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0RXhjZXB0aW9uQnJlYWtwb2ludHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdkYXRhQnJlYWtwb2ludEluZm8nLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkRhdGFCcmVha3BvaW50SW5mb0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRGF0YUJyZWFrcG9pbnRJbmZvUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc2V0RGF0YUJyZWFrcG9pbnRzJywgYXJnczogRGVidWdQcm90b2NvbC5TZXREYXRhQnJlYWtwb2ludHNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlNldERhdGFCcmVha3BvaW50c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2NvbnRpbnVlJywgYXJnczogRGVidWdQcm90b2NvbC5Db250aW51ZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29udGludWVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICduZXh0JywgYXJnczogRGVidWdQcm90b2NvbC5OZXh0QXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5OZXh0UmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnc3RlcEluJywgYXJnczogRGVidWdQcm90b2NvbC5TdGVwSW5Bcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBJblJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3N0ZXBPdXQnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0ZXBPdXRBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBPdXRSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzdGVwQmFjaycsIGFyZ3M6IERlYnVnUHJvdG9jb2wuU3RlcEJhY2tBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0ZXBCYWNrUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAncmV2ZXJzZUNvbnRpbnVlJywgYXJnczogRGVidWdQcm90b2NvbC5SZXZlcnNlQ29udGludWVBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJldmVyc2VDb250aW51ZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3Jlc3RhcnRGcmFtZScsIGFyZ3M6IERlYnVnUHJvdG9jb2wuUmVzdGFydEZyYW1lQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5SZXN0YXJ0RnJhbWVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdnb3RvJywgYXJnczogRGVidWdQcm90b2NvbC5Hb3RvQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Hb3RvUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAncGF1c2UnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlBhdXNlQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5QYXVzZVJlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3N0YWNrVHJhY2UnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlN0YWNrVHJhY2VBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlN0YWNrVHJhY2VSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzY29wZXMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlNjb3Blc0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2NvcGVzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAndmFyaWFibGVzJywgYXJnczogRGVidWdQcm90b2NvbC5WYXJpYWJsZXNBcmd1bWVudHMpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlZhcmlhYmxlc1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ3NldFZhcmlhYmxlJywgYXJnczogRGVidWdQcm90b2NvbC5TZXRWYXJpYWJsZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU2V0VmFyaWFibGVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzb3VyY2UnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLlNvdXJjZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuU291cmNlUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAndGhyZWFkcycpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlRocmVhZHNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdtb2R1bGVzJykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuTW9kdWxlc1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2V2YWx1YXRlJywgYXJnczogRGVidWdQcm90b2NvbC5FdmFsdWF0ZUFyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuRXZhbHVhdGVSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdzdGVwSW5UYXJnZXRzJywgYXJnczogRGVidWdQcm90b2NvbC5TdGVwSW5UYXJnZXRzQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5TdGVwSW5UYXJnZXRzUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiAnZ290b1RhcmdldHMnLCBhcmdzOiBEZWJ1Z1Byb3RvY29sLkdvdG9UYXJnZXRzQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5Hb3RvVGFyZ2V0c1Jlc3BvbnNlPjtcblx0cHVibGljIHNlbmQoY29tbWFuZDogJ2NvbXBsZXRpb25zJywgYXJnczogRGVidWdQcm90b2NvbC5Db21wbGV0aW9uc0FyZ3VtZW50cykgOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuQ29tcGxldGlvbnNSZXNwb25zZT47XG5cdHB1YmxpYyBzZW5kKGNvbW1hbmQ6ICdleGNlcHRpb25JbmZvJywgYXJnczogRGVidWdQcm90b2NvbC5FeGNlcHRpb25JbmZvQXJndW1lbnRzKSA6IFByb21pc2U8RGVidWdQcm90b2NvbC5FeGNlcHRpb25JbmZvUmVzcG9uc2U+O1xuXHRwdWJsaWMgc2VuZChjb21tYW5kOiBzdHJpbmcsIGFyZ3M/OiBhbnkpIDogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlPjtcblxuXHRwdWJsaWMgc2VuZChjb21tYW5kOiBzdHJpbmcsIGFyZ3M/OiBhbnkpOiBQcm9taXNlPERlYnVnUHJvdG9jb2wuUmVzcG9uc2U+IHtcblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgoY29tcGxldGVEaXNwYXRjaCwgZXJyb3JEaXNwYXRjaCkgPT4ge1xuXHRcdFx0dGhpcy5kb1NlbmQoY29tbWFuZCwgYXJncywgKHJlc3VsdDogRGVidWdQcm90b2NvbC5SZXNwb25zZSkgPT4ge1xuXHRcdFx0XHRpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcblx0XHRcdFx0XHRjb21wbGV0ZURpc3BhdGNoKHJlc3VsdCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0ZXJyb3JEaXNwYXRjaChuZXcgRXJyb3IocmVzdWx0Lm1lc3NhZ2UpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIGRvU2VuZChjb21tYW5kOiBzdHJpbmcsIGFyZ3M6IGFueSwgY2xiOiAocmVzdWx0OiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKSA9PiB2b2lkKTogdm9pZCB7XG5cblx0XHRjb25zdCByZXF1ZXN0OiBEZWJ1Z1Byb3RvY29sLlJlcXVlc3QgPSB7XG5cdFx0XHR0eXBlOiAncmVxdWVzdCcsXG5cdFx0XHRzZXE6IHRoaXMuc2VxdWVuY2UrKyxcblx0XHRcdGNvbW1hbmQ6IGNvbW1hbmRcblx0XHR9O1xuXHRcdGlmIChhcmdzICYmIE9iamVjdC5rZXlzKGFyZ3MpLmxlbmd0aCA+IDApIHtcblx0XHRcdHJlcXVlc3QuYXJndW1lbnRzID0gYXJncztcblx0XHR9XG5cblx0XHQvLyBzdG9yZSBjYWxsYmFjayBmb3IgdGhpcyByZXF1ZXN0XG5cdFx0dGhpcy5wZW5kaW5nUmVxdWVzdHMuc2V0KHJlcXVlc3Quc2VxLCBjbGIpO1xuXG5cdFx0Y29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpO1xuXHRcdHRoaXMub3V0cHV0U3RyZWFtLndyaXRlKGBDb250ZW50LUxlbmd0aDogJHtCdWZmZXIuYnl0ZUxlbmd0aChqc29uLCAndXRmOCcpfVxcclxcblxcclxcbiR7anNvbn1gLCAndXRmOCcpO1xuXHR9XG5cblx0cHJpdmF0ZSBoYW5kbGVEYXRhKGRhdGE6IEJ1ZmZlcik6IHZvaWQge1xuXG5cdFx0dGhpcy5yYXdEYXRhID0gQnVmZmVyLmNvbmNhdChbdGhpcy5yYXdEYXRhLCBkYXRhXSk7XG5cblx0XHR3aGlsZSAodHJ1ZSkge1xuXHRcdFx0aWYgKHRoaXMuY29udGVudExlbmd0aCA+PSAwKSB7XG5cdFx0XHRcdGlmICh0aGlzLnJhd0RhdGEubGVuZ3RoID49IHRoaXMuY29udGVudExlbmd0aCkge1xuXHRcdFx0XHRcdGNvbnN0IG1lc3NhZ2UgPSB0aGlzLnJhd0RhdGEudG9TdHJpbmcoJ3V0ZjgnLCAwLCB0aGlzLmNvbnRlbnRMZW5ndGgpO1xuXHRcdFx0XHRcdHRoaXMucmF3RGF0YSA9IHRoaXMucmF3RGF0YS5zbGljZSh0aGlzLmNvbnRlbnRMZW5ndGgpO1xuXHRcdFx0XHRcdHRoaXMuY29udGVudExlbmd0aCA9IC0xO1xuXHRcdFx0XHRcdGlmIChtZXNzYWdlLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRcdHRoaXMuZGlzcGF0Y2gobWVzc2FnZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNvbnRpbnVlO1x0Ly8gdGhlcmUgbWF5IGJlIG1vcmUgY29tcGxldGUgbWVzc2FnZXMgdG8gcHJvY2Vzc1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zdCBpZHggPSB0aGlzLnJhd0RhdGEuaW5kZXhPZihQcm90b2NvbENsaWVudC5UV09fQ1JMRik7XG5cdFx0XHRcdGlmIChpZHggIT09IC0xKSB7XG5cdFx0XHRcdFx0Y29uc3QgaGVhZGVyID0gdGhpcy5yYXdEYXRhLnRvU3RyaW5nKCd1dGY4JywgMCwgaWR4KTtcblx0XHRcdFx0XHRjb25zdCBsaW5lcyA9IGhlYWRlci5zcGxpdCgnXFxyXFxuJyk7XG5cdFx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRcdFx0Y29uc3QgcGFpciA9IGxpbmVzW2ldLnNwbGl0KC86ICsvKTtcblx0XHRcdFx0XHRcdGlmIChwYWlyWzBdID09PSAnQ29udGVudC1MZW5ndGgnKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuY29udGVudExlbmd0aCA9ICtwYWlyWzFdO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHR0aGlzLnJhd0RhdGEgPSB0aGlzLnJhd0RhdGEuc2xpY2UoaWR4ICsgUHJvdG9jb2xDbGllbnQuVFdPX0NSTEYubGVuZ3RoKTtcblx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBkaXNwYXRjaChib2R5OiBzdHJpbmcpOiB2b2lkIHtcblxuXHRcdGNvbnN0IHJhd0RhdGEgPSBKU09OLnBhcnNlKGJvZHkpO1xuXG5cdFx0aWYgKHR5cGVvZiByYXdEYXRhLmV2ZW50ICE9PSAndW5kZWZpbmVkJykge1xuXHRcdFx0Y29uc3QgZXZlbnQgPSA8RGVidWdQcm90b2NvbC5FdmVudD4gcmF3RGF0YTtcblx0XHRcdHRoaXMuZW1pdChldmVudC5ldmVudCwgZXZlbnQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCByZXNwb25zZSA9IDxEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlPiByYXdEYXRhO1xuXHRcdFx0Y29uc3QgY2xiID0gdGhpcy5wZW5kaW5nUmVxdWVzdHMuZ2V0KHJlc3BvbnNlLnJlcXVlc3Rfc2VxKTtcblx0XHRcdGlmIChjbGIpIHtcblx0XHRcdFx0dGhpcy5wZW5kaW5nUmVxdWVzdHMuZGVsZXRlKHJlc3BvbnNlLnJlcXVlc3Rfc2VxKTtcblx0XHRcdFx0Y2xiKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cbiJdfQ==